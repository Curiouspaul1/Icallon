<!DOCTYPE html>
<html>

<head>
    <title>Icallonüó£Ô∏è | Multiplayer Word Game</title>
    <link rel="icon" type="image/svg+xml" href="fav.svg">
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css">
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        .add-cat-trigger-btn {
            background: transparent;
            color: #777;
            border: 2px dashed #ccc;
            width: 100%;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .add-cat-trigger-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .custom-cat-input-group {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .alpha-section {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;
            text-align: left;
        }

        .alpha-options {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .alpha-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            margin-bottom: 10px;
        }

        .alpha-check-label {
            display: inline-block;
            width: 32px;
            height: 32px;
            line-height: 32px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            user-select: none;
            font-weight: bold;
            background-color: #f9f9f9;
            color: #bbb;
            transition: all 0.2s;
        }

        .alpha-check-input {
            display: none;
        }

        .alpha-check-input:checked+.alpha-check-label {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 5px rgba(222, 100, 73, 0.4);
        }

        .alpha-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: #666;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-sample {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            display: inline-block;
        }

        .legend-sample.active {
            background-color: var(--primary);
        }

        .legend-sample.inactive {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
        }

        .vote-live-tally {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 15px;
            font-weight: bold;
            font-size: 0.9rem;
            color: #555;
        }

        .tally-yes {
            color: #27ae60;
        }

        .tally-no {
            color: #c0392b;
        }
    </style>
</head>

<body>
    <div class="app-background"></div>
    <div class="container">
        <div id="sound-toggle" class="icon-btn floating-icon"><i class="fas fa-volume-up"></i></div>
        <div class="game-header">
            <div class="logo">
                <img src="icon.svg" alt="Icallon Logo" style="height: 50px;">
            </div>
            <div id="help-icon" class="icon-btn"><i class="fas fa-question-circle"></i></div>
        </div>

        <div id="username-screen" class="game-screen">
            <h2>Who are you?</h2>
            <input type="text" id="username" placeholder="Enter Nickname" autocomplete="off"><br>
            <button type="button" class="pure-button btn-action" id="submit-username">ENTER <i
                    class="fas fa-arrow-right"></i></button>
        </div>

        <div id="game-selection-screen" class="game-screen" style="display: none;">
            <h1>Menu</h1>
            <button type="button" class="pure-button btn-primary" id="btn-goto-setup">Create Game</button>
            <button type="button" class="pure-button btn-secondary" id="join-game-button">Join Game</button>
        </div>

        <div id="game-setup-screen" class="game-screen" style="display: none;">
            <h2>Game Setup</h2>
            <p>Select Categories:</p>
            <div class="setup-checkboxes">
                <label><input type="checkbox" class="cat-check" value="Name" checked> Name</label>
                <label><input type="checkbox" class="cat-check" value="Animal" checked> Animal</label>
                <label><input type="checkbox" class="cat-check" value="Place" checked> Place</label>
                <label><input type="checkbox" class="cat-check" value="Thing" checked> Thing</label>
            </div>
            <button type="button" id="show-add-cat-ui" class="add-cat-trigger-btn">
                <i class="fas fa-plus"></i> Add New Category
            </button>
            <div class="custom-cat-input-group" style="display: none;">
                <input type="text" id="new-cat-name" placeholder="E.g. Anime" style="flex-grow:1; margin:0;">
                <button type="button" id="add-cat-btn" class="pure-button" style="background: #2ecc71; color: white;">
                    <i class="fas fa-check"></i>
                </button>
            </div>
            <div id="custom-cat-list"></div>

            <div class="alpha-section">
                <h4>Available Letters</h4>
                <div class="alpha-options">
                    <label><input type="radio" name="alpha-mode" value="full" checked> Default (A-Z)</label>
                    <label><input type="radio" name="alpha-mode" value="custom"> Custom</label>
                </div>
                <div id="custom-alpha-container" style="display: none;">
                    <div class="alpha-legend">
                        <div class="legend-item"><span class="legend-sample active"></span> <span>Included</span></div>
                        <div class="legend-item"><span class="legend-sample inactive"></span> <span>Removed</span></div>
                    </div>
                    <div class="alpha-grid" id="alpha-grid-items"></div>
                    <small style="display:block; margin-top:10px; color:#555; line-height: 1.4;">
                        <i class="fas fa-info-circle"></i> <strong>Note:</strong> All letters are active by default.<br>
                        Click a letter to <span style="color: #999; font-weight: bold;">remove</span> it from the game.
                    </small>
                </div>
            </div>
            <button type="button" class="pure-button btn-action" id="create-game-confirm">CREATE ROOM</button>
            <button type="button" class="pure-button btn-text" onclick="location.reload()">Back</button>
        </div>

        <div id="join-game-screen" class="game-screen" style="display: none;">
            <h2>Enter Code</h2>
            <input type="text" id="game-key" placeholder="e.g. A1B2" maxlength="12">
            <button type="button" class="pure-button btn-action" id="submit-game-key">JOIN</button>
            <button type="button" class="pure-button btn-text" onclick="location.reload()">Back</button>
        </div>

        <div id="create-game-screen" class="game-screen" style="display: none;">
            <div class="room-code-display">
                <small>ROOM CODE</small>
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <span id="display-game-code" style="font-size: 2.5rem; letter-spacing: 5px;">----</span>
                    <button id="copy-link-btn" class="icon-btn" style="background:none; border:none; font-size:1.2rem;"
                        title="Copy Invite Link">
                        <i class="fas fa-link"></i>
                    </button>
                </div>
                <div id="qr-container" style="margin-top: 15px; display:none;">
                    <img id="room-qr-code" src="" alt="Scan to Join"
                        style="width: 120px; border-radius: 10px; border: 4px solid white;">
                    <p style="font-size: 0.8rem; color: #777; margin-top: 5px;">Scan to Join</p>
                </div>
            </div>
            <div id="player-list">
                <h3>Players Joined</h3>
                <div class="avatar-grid" id="lobby-avatars"></div>
            </div>
            <button type="button" class="pure-button btn-action" id="start-game-button" disabled>START GAME</button>
            <p id="waiting-msg" style="display:none; color: #777;">Waiting for host to start...</p>
            <button type="button" id="leave-lobby-btn" class="pure-button" style="background:none; border:none; color:#e74c3c; text-decoration:underline; margin-top:15px;">
                Leave Room
            </button>
        </div>

        <div id="game-arena" class="game-screen" style="display: none;">
            <div id="exit-game-btn" class="icon-btn" style="position: absolute; top: -50px; right: 0; color: #e74c3c; font-size: 1.2rem;" title="Leave Game">
                <i class="fas fa-sign-out-alt"></i>
            </div>
            <div class="round-info">
                <div id="turn-indicator">Waiting...</div>
                <div id="countdown" class="timer-badge"></div>
            </div>
            <div class="avatar-container" id="player-avatars"></div>
            <div class="letter-selection" id="letter-selection" style="display: none;"></div>
            <div id="dynamic-inputs-area" style="display: none;">
                <div class="category-card">
                    <h3 id="current-category-label">Category</h3>
                    <input type="text" id="current-input" placeholder="Type here..." autocomplete="off">
                </div>
                <div class="progress-dots" id="dynamic-dots"></div>
                <button type="button" id="next-field" class="pure-button btn-next">NEXT</button>
            </div>
        </div>

        <div id="voting-screen" class="game-screen" style="display: none;">
            <h2>‚ö† Democracy Time ‚ö†</h2>
            <p>Vote on words the app couldn't verify:</p>
            <div id="voting-container"></div>
            <button type="button" id="submit-votes" class="pure-button btn-action">Submit Votes</button>
        </div>

        <div class="leaderboard" id="leaderboard" style="display: none;">
            <h1>Round Results</h1>
            <div id="leaderboard-content"></div>
        </div>

        <div id="results-overlay" class="overlay" style="display: none;">
            <div class="loader"></div>
            <p>Waiting...</p>
        </div>

        <div id="help-overlay" class="overlay" style="display:none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>How to Play</h2>
                    <span id="help-close-btn" class="close-btn">&times;</span>
                </div>
                <div class="modal-body">
                    <p>1. <strong>Pick a letter</strong> when it's your turn.</p>
                    <p>2. <strong>Type fast!</strong> Fill in all categories.</p>
                    <p>3. <strong>Vote!</strong> If the dictionary doesn't know a word, you decide.</p>
                </div>
            </div>
        </div>
        <audio id="backgroundMusic" loop>
            <source src="sounds/theme1.mp3" type="audio/mpeg">
        </audio>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"></script>
    <script>
        $(document).ready(function () {
            let socket;
            let storedUsername = sessionStorage.getItem('username');
            let gameCode = '';
            let currentLetter;
            let isHost = false;
            let roundTimer;
            let turnTimerInterval;
            const urlParams = new URLSearchParams(window.location.search);
            let inviteCode = urlParams.get('code'); // e.g., ?code=ABCD

            // Your Cloud Run URL
            let serverURL = 'https://icallon-262474602690.africa-south1.run.app';
            // let serverURL = 'http://127.0.0.1:5000'

            let activeCategories = [];
            let gameAlphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            let currentCatIndex = 0;
            let activeInputs = {};
            let customCategories = [];

            // --- 1. TOKEN GENERATION ---
            function getOrGenerateToken() {
                let token = localStorage.getItem('player_token');
                if (!token) {
                    // Generate a random ID
                    token = Math.random().toString(36).substring(2) + Date.now().toString(36);
                    localStorage.setItem('player_token', token);
                }
                return token;
            }

            // --- 2. AUTO LOGIN / MANUAL LOGIN ---
            if (storedUsername) {
                $('#username').val(storedUsername);
                setupSocket(storedUsername);
            } else {
                $('#username-screen').show();
                // If invited, show a friendly message
                if (inviteCode) $('#username-screen h2').text(`Join Room ${inviteCode}? Enter Name:`);
            }

            // Login Button Handler
            $('#submit-username').click(function (e) {
                if (e) e.preventDefault();
                let user = $('#username').val().trim();
                if (user) {
                    $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Connecting...');
                    setupSocket(user);
                } else {
                    $('#username').addClass('invalid').focus();
                }
            });

            $('#username').keypress(function (e) { if (e.which == 13) { e.preventDefault(); $('#submit-username').click(); } });

            // --- 3. SOCKET SETUP WITH AUTH ---
            function setupSocket(user) {
                // If we already have a live socket, don't reconnect
                if (socket && socket.connected) return;

                let token = getOrGenerateToken();

                socket = io(
                    serverURL,
                    {
                        withCredentials: true,
                        transports: ['websocket', 'polling'], // Allow websockets now that we use token auth
                        auth: {
                            username: user,
                            token: token
                        }
                    }
                );

                // --- CONNECTION SUCCESS ---
                socket.on('connect', () => {
                    console.log("Connected as " + user);
                    sessionStorage.setItem('username', user);

                    // --- INVITE LOGIC ---
                    // If there is an invite code, JOIN IMMEDIATELY instead of showing menu
                    if (inviteCode) {
                        gameCode = inviteCode;
                        // Clear the URL so refreshing doesn't loop forever or look messy
                        window.history.replaceState({}, document.title, "/");

                        socket.emit('join', { roomID: gameCode });
                        // Switch to a loading screen momentarily
                        showOverlay("Joining Room " + gameCode + "...");
                    } else {
                        switchScreen('game-selection-screen');
                    }
                });

                socket.on('left_room_success', () => {
                    gameCode = '';
                    isHost = false;
                    inviteCode = null; // Clear invite code so they don't auto-rejoin
                    // Clear UI State
                    $('#lobby-avatars').empty();
                    $('#player-avatars').empty();
                    // Go back to Menu
                    switchScreen('game-selection-screen');
                });

                // --- CONNECTION ERROR (e.g. Username Taken) ---
                socket.on('connect_error', (err) => {
                    alert("Connection Failed: Username might be taken.");
                    $('#submit-username').prop('disabled', false).html('ENTER <i class="fas fa-arrow-right"></i>');
                    if ($('#game-selection-screen').is(':hidden')) switchScreen('username-screen');
                    socket.disconnect();
                });

                // --- GAME HANDLERS ---
                socket.on('error', (data) => {
                    hideOverlay();
                    alert(data.message);
                    // If join failed, go back to menu
                    switchScreen('game-selection-screen');
                    $('#submit-game-key').prop('disabled', false).text('JOIN');
                });
                socket.on('game_code', (code) => {
                    gameCode = code;
                    $('#display-game-code').text(code);

                    // GENERATE QR & LINK
                    let joinLink = `${window.location.origin}/?code=${code}`;

                    // Use a free public API for QR codes (simple & effective)
                    let qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(joinLink)}`;
                    $('#room-qr-code').attr('src', qrUrl);
                    $('#qr-container').fadeIn();

                    switchScreen('create-game-screen');
                });

                socket.on('info_toast', (data) => {
                    let t = $(`<div style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#e74c3c; color:white; padding:10px 20px; border-radius:5px; z-index:9999;">${data.message}</div>`);
                    $('body').append(t);
                    setTimeout(() => t.fadeOut(() => t.remove()), 3000);
                });

                socket.on('player_joined', (players) => {
                    hideOverlay(); 
                    $('#lobby-avatars').empty(); 
                    $('#player-avatars').empty();
                    
                    players.forEach(p => { 
                        let html = `<div class="avatar"><img src="avatar.png"><span>${p}</span></div>`; 
                        $('#lobby-avatars').append(html); 
                        $('#player-avatars').append(html); 
                    });
                    
                    // Handle Auto-Join Screen Switching
                    if ($('#join-game-screen').is(':visible') || inviteCode) { 
                        $('#display-game-code').text(gameCode);
                        switchScreen('create-game-screen'); 
                    }
                    
                    if (isHost) { 
                        $('#start-game-button').show().prop('disabled', players.length < 2); 
                        $('#waiting-msg').hide(); 
                        
                        // HOST: Ensure QR is visible
                        let joinLink = `${window.location.origin}/?code=${gameCode}`;
                        let qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(joinLink)}`;
                        $('#room-qr-code').attr('src', qrUrl);
                        $('#qr-container').show();
                    } else { 
                        // GUEST: Hide controls, show waiting message
                        $('#start-game-button').hide(); 
                        $('#waiting-msg').show(); 
                        
                        // FIX: Hide QR code for guests to keep UI clean
                        $('#qr-container').hide();
                    }
                });

                socket.on('player_left', (players) => {
                    $('#lobby-avatars').empty(); $('#player-avatars').empty();
                    players.forEach(p => { let html = `<div class="avatar"><img src="avatar.png"><span>${p}</span></div>`; $('#lobby-avatars').append(html); $('#player-avatars').append(html); });
                    if (isHost) $('#start-game-button').prop('disabled', players.length < 2);
                });

                socket.on('game_started', (data) => {
                    activeCategories = data.categories; gameAlphabet = data.allowed_letters;
                    switchScreen('game-arena'); bgMusic.play().catch(e => console.log("Audio requires interaction"));
                });

                socket.on('private_player_turn', (data) => { showLetterSelection(data.disabledLetters); startTurnCountdown(10); });
                socket.on('public_player_turn', (player) => { if (player !== sessionStorage.getItem('username')) { $('#letter-selection').hide(); waitTurnTimer(player); } });
                socket.on('letter_chosen', (letter) => { clearInterval(turnTimerInterval); currentLetter = letter; $('#letter-selection').hide(); $('#turn-indicator').text(`Current Letter: ${letter}`); currentCatIndex = 0; activeInputs = {}; updateInputUI(); $('#dynamic-inputs-area').fadeIn(); startTimer(30); });
                socket.on('force_submit', () => { if ($('#dynamic-inputs-area').is(':visible')) sendPlayerAnswers("Calculating results..."); else showOverlay("Calculating results..."); });

                socket.on('start_voting', (contested) => {
                    hideOverlay(); $('#game-arena').hide(); $('#voting-container').empty(); $('#submit-votes').prop('disabled', false).text('Submit Votes');
                    contested.forEach((item, i) => {
                        let isMine = item.player === sessionStorage.getItem('username');
                        let html = `<div class="voting-card" data-id="${item.id}"><div class="vote-meta">${item.category} by ${item.player}</div><div class="vote-word">${item.word}</div>${isMine ? '<div class="my-word">Your Word</div>' : `<div class="vote-opts"><label><input type="radio" name="v_${i}" value="yes" checked> ‚úÖ Yes</label><label><input type="radio" name="v_${i}" value="no"> ‚ùå No</label></div>`}<div class="vote-live-tally"><span class="tally-yes" id="yes-${item.id}">‚úÖ 0</span><span class="tally-no" id="no-${item.id}">‚ùå 0</span></div></div>`;
                        $('#voting-container').append(html);
                    });
                    switchScreen('voting-screen');
                });
                socket.on('vote_update', (items) => { items.forEach(item => { $(`#yes-${item.id}`).text(`‚úÖ ${item.votes_yes}`); $(`#no-${item.id}`).text(`‚ùå ${item.votes_no}`); }); });

                socket.on('round_result', (scores) => { hideOverlay(); $('#voting-screen').hide(); $('#game-arena').show(); $('#leaderboard-content').empty(); let sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]); sorted.forEach((entry, i) => { $('#leaderboard-content').append(`<div class="leaderboard-item"><div class="rank">#${i + 1}</div><div class="name">${entry[0]}</div><div class="score">${entry[1]} pts</div></div>`); }); $('#leaderboard').fadeIn(); setTimeout(() => $('#leaderboard').fadeOut(), 5000); });
            }

            // --- UI HELPERS ---

            initAlphaGrid();
            function initAlphaGrid() {
                let alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                for (let i = 0; i < alpha.length; i++) {
                    let c = alpha[i];
                    $('#alpha-grid-items').append(`<label><input type="checkbox" class="alpha-check-input" value="${c}" checked><span class="alpha-check-label">${c}</span></label>`);
                }
                $('input[name="alpha-mode"]').change(function () {
                    if ($(this).val() === 'custom') $('#custom-alpha-container').slideDown();
                    else $('#custom-alpha-container').slideUp();
                });
            }

            function waitTurnTimer(player) {
                let t = 10;
                $('#turn-indicator').text(`Waiting for ${player} (${t}s)...`);
                clearInterval(turnTimerInterval);
                turnTimerInterval = setInterval(() => {
                    t--;
                    if (t > 0) $('#turn-indicator').text(`Waiting for ${player} (${t}s)...`);
                    else clearInterval(turnTimerInterval);
                }, 1000);
            }

            function showToast(msg) {
                let t = $(`<div style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#34495e; color:white; padding:10px 20px; border-radius:30px; z-index:9999; box-shadow:0 5px 15px rgba(0,0,0,0.2); font-weight:bold;">${msg}</div>`);
                $('body').append(t);
                setTimeout(() => t.fadeOut(() => t.remove()), 3000);
            }

            function startTurnCountdown(seconds) {
                clearInterval(turnTimerInterval);
                $('#turn-indicator').text(`üî• Your Turn! Pick a Letter (${seconds}s) üî•`);
                turnTimerInterval = setInterval(() => {
                    seconds--;
                    if (seconds >= 0) $('#turn-indicator').text(`üî• Your Turn! Pick a Letter (${seconds}s) üî•`);
                    else clearInterval(turnTimerInterval);
                }, 1000);
            }

            function leaveGame() {
                if (confirm("Are you sure you want to leave this room?")) {
                    socket.emit('leave_room', { room_id: gameCode });
                }
            }

            $('#leave-lobby-btn, #exit-game-btn').click(function(e) {
                e.preventDefault();
                if (confirm("Are you sure you want to leave?")) {
                    // Emit the event to the server
                    if (socket && socket.connected) {
                        socket.emit('leave_room', { room_id: gameCode });
                    } else {
                        // Fallback if connection is lost: Force leave locally
                        switchScreen('game-selection-screen');
                    }
                }
            });

            $('#exit-game-btn').click((e) => {
                e.preventDefault();
                leaveGame();
            });
            $('#copy-link-btn').click(function () {
                if (!gameCode) return;
                const link = `${window.location.origin}/?code=${gameCode}`;

                navigator.clipboard.writeText(link).then(() => {
                    showToast("Link Copied to Clipboard!");
                    $(this).css('color', '#27ae60'); // Turn green momentarily
                    setTimeout(() => $(this).css('color', ''), 1000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    prompt("Copy this link:", link); // Fallback
                });
            });
            $('#btn-goto-setup').click((e) => { e.preventDefault(); switchScreen('game-setup-screen'); });
            $('#show-add-cat-ui').click(function () { $(this).hide(); $('.custom-cat-input-group').css('display', 'flex'); $('#new-cat-name').focus(); });
            $('#add-cat-btn').click(function (e) {
                e.preventDefault();
                let val = $('#new-cat-name').val().trim();
                val = val.charAt(0).toUpperCase() + val.slice(1);
                if (val && !customCategories.includes(val)) { customCategories.push(val); renderCustomTags(); }
                $('#new-cat-name').val(''); $('.custom-cat-input-group').hide(); $('#show-add-cat-ui').show();
            });

            function renderCustomTags() {
                $('#custom-cat-list').empty();
                customCategories.forEach((cat, idx) => {
                    let tag = $(`<span class="custom-tag">${cat} <i class="fas fa-times"></i></span>`);
                    tag.find('i').click(() => { customCategories.splice(idx, 1); renderCustomTags(); });
                    $('#custom-cat-list').append(tag);
                });
            }

            $('#create-game-confirm').click((e) => {
                e.preventDefault();
                isHost = true;
                let pendingCat = $('#new-cat-name').val().trim();
                if (pendingCat) {
                    pendingCat = pendingCat.charAt(0).toUpperCase() + pendingCat.slice(1);
                    if (!customCategories.includes(pendingCat)) customCategories.push(pendingCat);
                }
                let selectedCats = [];
                $('.cat-check:checked').each(function () { selectedCats.push($(this).val()); });
                selectedCats = selectedCats.concat(customCategories);
                if (selectedCats.length < 1) { alert("Pick at least one category!"); return; }
                let alphaMode = $('input[name="alpha-mode"]:checked').val();
                let selectedAlpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                if (alphaMode === 'custom') {
                    let chars = [];
                    $('.alpha-check-input:checked').each(function () { chars.push($(this).val()); });
                    if (chars.length < 1) { alert("Pick at least one letter!"); return; }
                    selectedAlpha = chars.join("");
                }
                socket.emit('create', { categories: selectedCats, allowed_letters: selectedAlpha });
            });

            $('#join-game-button').click((e) => { e.preventDefault(); switchScreen('join-game-screen'); });
            $('#submit-game-key').click(function (e) {
                e.preventDefault(); gameCode = $('#game-key').val().trim();
                if (!gameCode) { alert("Please enter a code"); return; }
                $(this).prop('disabled', true).text('Joining...'); isHost = false;
                socket.emit('join', { roomID: gameCode });
            });
            $('#start-game-button').click((e) => { e.preventDefault(); socket.emit('start', { room_id: gameCode }); });

            $('#next-field').click(function (e) {
                e.preventDefault();
                let catName = activeCategories[currentCatIndex];
                activeInputs[catName] = $('#current-input').val();
                if (currentCatIndex < activeCategories.length - 1) { currentCatIndex++; updateInputUI(); }
                else { sendPlayerAnswers(); }
            });
            $('#current-input').keypress(function (e) { if (e.which == 13) { e.preventDefault(); $('#next-field').click(); } });
            $('#submit-votes').click(function (e) {
                e.preventDefault();
                let votes = {};
                $('.voting-card').each(function () {
                    let id = $(this).data('id');
                    if ($(this).find('input[type="radio"]').length > 0) {
                        let val = $(this).find('input[type="radio"]:checked').val();
                        votes[id] = (val !== 'no');
                    }
                });
                $(this).prop('disabled', true).text("Watching Results...");
                $('.vote-opts input').prop('disabled', true);
                socket.emit('cast_votes', { room_id: gameCode, votes: votes });
            });
            $('#help-icon').click(() => $('#help-overlay').fadeIn());
            $('#help-close-btn').click(() => $('#help-overlay').fadeOut());
            const bgMusic = document.getElementById('backgroundMusic');
            bgMusic.volume = 0.2;
            $('#sound-toggle').click(() => {
                if (bgMusic.muted) { bgMusic.muted = false; $('#sound-toggle i').attr('class', 'fas fa-volume-up'); }
                else { bgMusic.muted = true; $('#sound-toggle i').attr('class', 'fas fa-volume-mute'); }
            });

            function showLetterSelection(disabledIndices) {
                $('#letter-selection').empty().show();
                gameAlphabet.split("").forEach((c) => {
                    let btn = $(`<button>${c}</button>`);
                    let absIdx = c.charCodeAt(0) - 64;
                    if (disabledIndices.includes(absIdx)) btn.prop('disabled', true);
                    btn.click(() => socket.emit('letter_selected', { letter: c, room_id: gameCode }));
                    $('#letter-selection').append(btn);
                });
            }

            function startTurnCountdown(seconds) {
                clearInterval(turnTimerInterval);
                $('#turn-indicator').text(`üî• Your Turn! Pick a Letter (${seconds}s) üî•`);
                turnTimerInterval = setInterval(() => {
                    seconds--;
                    if (seconds >= 0) $('#turn-indicator').text(`üî• Your Turn! Pick a Letter (${seconds}s) üî•`);
                    else clearInterval(turnTimerInterval);
                }, 1000);
            }

            function startTimer(sec) {
                clearInterval(roundTimer); $('#countdown').text(sec).show();
                roundTimer = setInterval(() => {
                    sec--; $('#countdown').text(sec);
                    if (sec < 0) {
                        clearInterval(roundTimer);
                        $('#countdown').hide();
                        sendPlayerAnswers("Calculating results...");
                    }
                }, 1000);
            }
            function switchScreen(id) { $('.game-screen').hide(); $('#' + id).fadeIn(); }
            function updateInputUI() {
                let catName = activeCategories[currentCatIndex];
                $('#current-category-label').text(catName); $('#current-input').val(activeInputs[catName] || ''); $('#current-input').focus();
                $('#dynamic-dots').empty();
                activeCategories.forEach((_, i) => { let d = $('<span class="dot"></span>'); if (i === currentCatIndex) d.addClass('active'); $('#dynamic-dots').append(d); });
                $('#next-field').text(currentCatIndex === activeCategories.length - 1 ? "FINISH!" : "NEXT");
            }

            function sendPlayerAnswers(customMsg) {
                if ($('#dynamic-inputs-area').is(':visible')) { let catName = activeCategories[currentCatIndex]; activeInputs[catName] = $('#current-input').val(); }
                clearInterval(roundTimer); $('#dynamic-inputs-area').hide();
                let msg = customMsg || "Waiting for others...";
                showOverlay(msg);
                socket.emit('player_answer', { answers: activeInputs, room_id: gameCode, letter: currentLetter });
            }
            function showOverlay(msg) { $('#results-overlay').fadeIn().find('p').text(msg); }
            function hideOverlay() { $('#results-overlay').fadeOut(); }
        });
    </script>
</body>

</html>